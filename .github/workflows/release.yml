name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

env:
  # Apple Developer Configuration
  # These will be empty if secrets are not set (fallback to ad-hoc signing)
  APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
  APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: core

      # ============================================================
      # APPLE DEVELOPER CERTIFICATE SETUP
      # ============================================================
      - name: Install Apple Developer Certificate
        if: ${{ env.APPLE_SIGNING_IDENTITY != '' }}
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ github.run_id }}
        run: |
          # Create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          # Decode certificate from base64
          echo -n "$APPLE_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH

          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate to keychain
          security import $CERTIFICATE_PATH -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          # Verify certificate
          echo "Installed certificates:"
          security find-identity -v -p codesigning $KEYCHAIN_PATH

      # ============================================================
      # BUILD
      # ============================================================
      - name: Build Rust Core (Universal Binary)
        run: |
          cd core
          cargo build --release --target aarch64-apple-darwin
          cargo build --release --target x86_64-apple-darwin
          lipo -create \
            target/aarch64-apple-darwin/release/libgonhanh_core.a \
            target/x86_64-apple-darwin/release/libgonhanh_core.a \
            -output ../platforms/macos/libgonhanh_core.a

      - name: Build macOS App
        env:
          CODE_SIGN_IDENTITY: ${{ env.APPLE_SIGNING_IDENTITY || '-' }}
          DEVELOPMENT_TEAM: ${{ env.APPLE_TEAM_ID }}
        run: |
          cd platforms/macos

          if [ -n "$APPLE_SIGNING_IDENTITY" ]; then
            echo "Building with Developer ID signing..."
            xcodebuild -scheme GoNhanh -configuration Release \
              -derivedDataPath build \
              CODE_SIGN_IDENTITY="$CODE_SIGN_IDENTITY" \
              DEVELOPMENT_TEAM="$DEVELOPMENT_TEAM" \
              CODE_SIGN_STYLE="Manual" \
              OTHER_CODE_SIGN_FLAGS="--options=runtime"
          else
            echo "Building with ad-hoc signing (no Apple Developer secrets configured)..."
            xcodebuild -scheme GoNhanh -configuration Release \
              -derivedDataPath build \
              CODE_SIGN_IDENTITY="-"
          fi

      # ============================================================
      # SET VERSION (Before signing)
      # ============================================================
      - name: Set Version in App
        run: |
          cd platforms/macos
          V="${GITHUB_REF_NAME#v}"
          APP="build/Build/Products/Release/GoNhanh.app"

          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $V" "$APP/Contents/Info.plist"
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $V" "$APP/Contents/Info.plist"
          echo "Version set to: $V"

      # ============================================================
      # CODE SIGNING & NOTARIZATION
      # ============================================================
      - name: Sign App with Entitlements
        env:
          CODE_SIGN_IDENTITY: ${{ env.APPLE_SIGNING_IDENTITY || '-' }}
        run: |
          cd platforms/macos
          APP="build/Build/Products/Release/GoNhanh.app"

          if [ -n "$APPLE_SIGNING_IDENTITY" ]; then
            echo "Signing with Developer ID and hardened runtime..."
            codesign --force --deep --sign "$CODE_SIGN_IDENTITY" \
              --entitlements GoNhanh.entitlements.production \
              --options runtime \
              --timestamp \
              "$APP"
          else
            echo "Signing with ad-hoc identity..."
            codesign --force --deep --sign - \
              --entitlements GoNhanh.entitlements \
              "$APP"
          fi

          # Verify signature
          echo "Verifying signature..."
          codesign -vvv --deep --strict "$APP"
          echo "Signature verified successfully!"

      - name: Submit Notarization & Wait (30 min timeout)
        if: ${{ env.APPLE_SIGNING_IDENTITY != '' }}
        id: notarize
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          cd platforms/macos
          APP="build/Build/Products/Release/GoNhanh.app"

          echo "Creating ZIP for notarization..."
          ditto -c -k --keepParent "$APP" "GoNhanh-notarize.zip"

          echo "Submitting to Apple for notarization..."
          xcrun notarytool submit "GoNhanh-notarize.zip" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --output-format json \
            --no-wait > notarization-result.json

          SUBMISSION_ID=$(jq -r '.id' notarization-result.json)
          echo "submission_id=$SUBMISSION_ID" >> $GITHUB_OUTPUT
          echo "✅ Submitted: $SUBMISSION_ID"

          # Wait up to 30 minutes for approval
          echo "Waiting for Apple approval (max 30 min)..."
          MAX_ATTEMPTS=60  # 60 * 30s = 30 min
          ATTEMPT=0
          STAPLED=false

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            sleep 30

            STATUS=$(xcrun notarytool info "$SUBMISSION_ID" \
              --apple-id "$APPLE_ID" \
              --password "$APPLE_APP_PASSWORD" \
              --team-id "$APPLE_TEAM_ID" \
              --output-format json 2>/dev/null | jq -r '.status' || echo "error")

            echo "[$ATTEMPT/$MAX_ATTEMPTS] Status: $STATUS"

            case "$STATUS" in
              "Accepted")
                echo "✅ Notarization accepted! Stapling..."
                xcrun stapler staple "$APP"
                STAPLED=true
                break
                ;;
              "Invalid"|"Rejected")
                echo "❌ Notarization rejected"
                break
                ;;
              "In Progress")
                continue
                ;;
            esac
          done

          echo "stapled=$STAPLED" >> $GITHUB_OUTPUT

          if [ "$STAPLED" = "false" ]; then
            echo "::warning::Notarization not completed within 30 min. Releasing unstapled DMG. Background job will update later."
          fi

          rm -f "GoNhanh-notarize.zip"

      - name: Upload Notarization Info
        if: ${{ env.APPLE_SIGNING_IDENTITY != '' && steps.notarize.outputs.stapled == 'false' }}
        uses: actions/upload-artifact@v4
        with:
          name: notarization-info
          path: platforms/macos/notarization-result.json
          retention-days: 30

      - name: Upload Signed App (for stapling later if needed)
        if: ${{ env.APPLE_SIGNING_IDENTITY != '' && steps.notarize.outputs.stapled == 'false' }}
        uses: actions/upload-artifact@v4
        with:
          name: signed-app
          path: platforms/macos/build/Build/Products/Release/GoNhanh.app
          retention-days: 30

      # ============================================================
      # PACKAGE & RELEASE
      # ============================================================
      - name: Create DMG
        run: |
          cd platforms/macos
          APP="build/Build/Products/Release/GoNhanh.app"
          ../../scripts/create-dmg.sh "$APP"

      - name: Get Tag Message
        id: tag_message
        run: |
          git fetch origin tag ${{ github.ref_name }} --force
          TAG_MSG=$(git for-each-ref --format='%(contents)' refs/tags/${{ github.ref_name }})

          echo "=== Tag message ==="
          echo "$TAG_MSG"
          echo "==================="

          {
            echo "message<<EOF"
            echo "$TAG_MSG"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: platforms/macos/build/*.dmg
          body: ${{ steps.tag_message.outputs.message }}
          generate_release_notes: ${{ steps.tag_message.outputs.message == '' }}

      # ============================================================
      # CLEANUP
      # ============================================================
      - name: Cleanup Keychain
        if: ${{ always() && env.APPLE_SIGNING_IDENTITY != '' }}
        run: |
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true

    outputs:
      submission_id: ${{ steps.notarize.outputs.submission_id }}
      stapled: ${{ steps.notarize.outputs.stapled }}

  # ============================================================
  # BACKGROUND STAPLING (only if 30 min timeout, notarization pending)
  # ============================================================
  staple-notarization:
    needs: build-macos
    if: ${{ needs.build-macos.outputs.submission_id != '' && needs.build-macos.outputs.stapled == 'false' }}
    runs-on: macos-latest
    continue-on-error: true  # Don't fail the whole workflow if stapling fails
    steps:
      - uses: actions/checkout@v4

      - name: Download Signed App
        uses: actions/download-artifact@v4
        with:
          name: signed-app
          path: GoNhanh.app

      - name: Wait for Notarization & Staple
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          SUBMISSION_ID: ${{ needs.build-macos.outputs.submission_id }}
        run: |
          echo "Waiting for notarization: $SUBMISSION_ID"
          echo "Polling every 30s, max 30 more minutes (already waited 30 min in main job)..."

          MAX_ATTEMPTS=60  # 60 * 30s = 30 min (total 60 min with main job)
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            sleep 30

            STATUS=$(xcrun notarytool info "$SUBMISSION_ID" \
              --apple-id "$APPLE_ID" \
              --password "$APPLE_APP_PASSWORD" \
              --team-id "$APPLE_TEAM_ID" \
              --output-format json 2>/dev/null | jq -r '.status' || echo "error")

            echo "[$ATTEMPT/$MAX_ATTEMPTS] Status: $STATUS"

            case "$STATUS" in
              "Accepted")
                echo "✅ Notarization accepted!"
                xcrun stapler staple "GoNhanh.app"
                echo "stapled=true" >> $GITHUB_ENV
                exit 0
                ;;
              "Invalid"|"Rejected")
                echo "❌ Notarization rejected"
                exit 1
                ;;
              "In Progress")
                continue
                ;;
            esac
          done

          echo "❌ Timeout waiting for notarization"
          exit 1

      - name: Create Stapled DMG
        if: ${{ env.stapled == 'true' }}
        run: |
          mkdir -p platforms/macos/build
          ./scripts/create-dmg.sh "GoNhanh.app"

      - name: Update Release with Stapled DMG
        if: ${{ env.stapled == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF_NAME}"
          DMG_FILE=$(ls platforms/macos/build/*.dmg | head -1)

          # Delete old asset and upload new one
          ASSET_ID=$(gh api "repos/${{ github.repository }}/releases/tags/$TAG" \
            --jq '.assets[] | select(.name == "GoNhanh.dmg") | .id' 2>/dev/null || echo "")

          if [ -n "$ASSET_ID" ]; then
            gh api -X DELETE "repos/${{ github.repository }}/releases/assets/$ASSET_ID"
          fi

          gh release upload "$TAG" "$DMG_FILE" --clobber
          echo "✅ Release updated with stapled DMG!"

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: core

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            fcitx5 \
            libfcitx5core-dev \
            libfcitx5config-dev \
            libfcitx5utils-dev \
            fcitx5-modules-dev \
            extra-cmake-modules \
            libxkbcommon-dev \
            cmake \
            pkg-config

      - name: Build
        run: |
          # Rust core
          cd core
          cargo build --release

          # Fcitx5 addon
          cd ../platforms/linux
          mkdir -p build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
          make -j$(nproc)

      - name: Package
        run: |
          PKG="gonhanh-linux"
          mkdir -p "$PKG/lib" "$PKG/share/fcitx5/addon" "$PKG/share/fcitx5/inputmethod"

          cp platforms/linux/build/gonhanh.so "$PKG/lib/"
          cp core/target/release/libgonhanh_core.so "$PKG/lib/"
          cp platforms/linux/data/gonhanh-addon.conf "$PKG/share/fcitx5/addon/gonhanh.conf"
          cp platforms/linux/data/gonhanh.conf "$PKG/share/fcitx5/inputmethod/"
          cp platforms/linux/README.md "$PKG/"
          cp platforms/linux/scripts/install.sh "$PKG/"
          chmod +x "$PKG/install.sh"

          tar -czvf "$PKG.tar.gz" "$PKG"

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-tarball
          path: "*.tar.gz"

      - name: Add to Release
        uses: softprops/action-gh-release@v2
        with:
          files: "*.tar.gz"

  # DEPRECATED: Gõ Nhanh now on official Homebrew (https://formulae.brew.sh/cask/gonhanh)
  # Homebrew autobump bot handles updates via livecheck. Keep for reference only.
  update-homebrew:
    if: false
    needs: build-macos
    runs-on: ubuntu-latest
    steps:
      - name: Download DMG and get SHA256
        id: sha
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          curl -L -o GoNhanh.dmg "https://github.com/khaphanspace/gonhanh.org/releases/download/${{ github.ref_name }}/GoNhanh.dmg"
          SHA256=$(shasum -a 256 GoNhanh.dmg | awk '{print $1}')
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Update Homebrew Cask
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          VERSION: ${{ steps.sha.outputs.version }}
          SHA256: ${{ steps.sha.outputs.sha256 }}
        run: |
          git clone https://x-access-token:${GH_TOKEN}@github.com/khaphanspace/homebrew-gonhanh.git
          cd homebrew-gonhanh

          cat > Casks/gonhanh.rb << 'EOF'
          cask "gonhanh" do
            version "VERSION_PLACEHOLDER"
            sha256 "SHA256_PLACEHOLDER"

            url "https://github.com/khaphanspace/gonhanh.org/releases/download/v#{version}/GoNhanh.dmg"
            name "Gõ Nhanh"
            desc "High-performance Vietnamese Input Method Engine for macOS"
            homepage "https://github.com/khaphanspace/gonhanh.org"

            auto_updates true

            livecheck do
              url :url
              strategy :github_latest
            end

            app "GoNhanh.app"

            preflight do
              system_command "/usr/bin/pkill",
                             args: ["-x", "GoNhanh"],
                             sudo: false,
                             must_succeed: false
              sleep 1
            end

            uninstall quit: "org.gonhanh.GoNhanh"

            postflight do
              system_command "/usr/bin/xattr",
                             args: ["-cr", "#{appdir}/GoNhanh.app"],
                             sudo: false
              system_command "/usr/bin/open",
                             args: ["-a", "GoNhanh"],
                             sudo: false
            end

            zap trash: [
              "~/Library/Preferences/space.khaphan.gonhanh.plist",
              "~/Library/Application Support/GoNhanh",
            ]
          end
          EOF
          sed -i 's/^          //' Casks/gonhanh.rb
          sed -i "s/VERSION_PLACEHOLDER/${VERSION}/" Casks/gonhanh.rb
          sed -i "s/SHA256_PLACEHOLDER/${SHA256}/" Casks/gonhanh.rb

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/gonhanh.rb
          git commit -m "Update gonhanh to ${VERSION}"
          git push

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: core

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Build Rust Core
        run: |
          cd core
          cargo build --release --target x86_64-pc-windows-msvc
          Copy-Item "target/x86_64-pc-windows-msvc/release/gonhanh_core.dll" `
                    "../platforms/windows/GoNhanh/Native/gonhanh_core.dll"

      - name: Build WPF App
        run: |
          cd platforms/windows/GoNhanh
          dotnet publish -c Release -r win-x64 --self-contained false -o ../publish

      - name: Package
        run: |
          cd platforms/windows
          $V = "${{ github.ref_name }}".TrimStart('v')
          Compress-Archive -Path publish/* -DestinationPath "GoNhanh-$V-win-x64.zip"

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-zip
          path: platforms/windows/*.zip

      - name: Add to Release
        uses: softprops/action-gh-release@v2
        with:
          files: platforms/windows/*.zip
