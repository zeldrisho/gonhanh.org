name: CI

on:
  push:
    branches: [main]
    tags-ignore: ['**']
  pull_request:
    branches: [main]

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: core
      - run: cargo fmt --manifest-path core/Cargo.toml -- --check
      - run: cargo clippy --manifest-path core/Cargo.toml -- -D warnings
      - run: cargo test --manifest-path core/Cargo.toml

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: core
      - run: cargo build --manifest-path core/Cargo.toml --release

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            fcitx5 \
            libfcitx5core-dev \
            libfcitx5config-dev \
            libfcitx5utils-dev \
            fcitx5-modules-dev \
            extra-cmake-modules \
            libxkbcommon-dev \
            libgtest-dev \
            cmake \
            pkg-config

      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: core

      - name: Build Rust core
        run: cargo build --manifest-path core/Cargo.toml --release

      - name: Build Fcitx5 addon
        run: |
          cd platforms/linux
          mkdir -p build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTS=ON
          make -j$(nproc)

      - name: Run tests
        run: |
          cd platforms/linux/build
          ./keycodemap_test --gtest_color=yes
          LD_LIBRARY_PATH="${GITHUB_WORKSPACE}/core/target/release:$LD_LIBRARY_PATH" \
            ./rustbridge_test --gtest_color=yes

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: core
      - name: Build Rust core
        run: powershell -ExecutionPolicy Bypass -File scripts/build-core-windows.ps1 -Release
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x
      - name: Build WPF App
        run: dotnet build -c Release platforms/windows/GoNhanh/GoNhanh.csproj
      - name: Run Rust tests
        run: cargo test --manifest-path core/Cargo.toml

